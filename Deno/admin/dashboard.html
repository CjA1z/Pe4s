<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <!-- Session validation script - must run first -->
  <script>
    // Immediately check if user is logged in
    (function() {
      const sessionToken = localStorage.getItem('session_token') || 
                         sessionStorage.getItem('session_token') || 
                         document.cookie.split(';').find(c => c.trim().startsWith('session_token='));
      
      // If no session token found, redirect immediately to index page
      if (!sessionToken) {
        console.log('No session token found, redirecting to index page');
        window.location.href = '/index.html?redirected=true&t=' + Date.now();
      }
    })();
  </script>
  <!-- Load all CSS with correct paths -->
  <link rel="stylesheet" href="/admin/Components/css/dashboard.css">
  <link rel="stylesheet" href="/admin/Components/css/side_bar.css">
  <link rel="stylesheet" href="/admin/Components/css/navbar_header.css">
  <link rel="stylesheet" href="/admin/Components/css/chart.css">
  <!-- Then load JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/Components/js/login.js"></script>
  <script src="/admin/Components/js/dashboard.js"></script>
  <script src="/admin/Components/js/side_bar.js"></script>
  <script src="/admin/Components/js/most-visited-works.js"></script>
  <script src="/admin/Components/js/trending-keywords.js"></script>
  <script src="/admin/Components/js/dashboard-chart.js"></script>
</head>
<body>
  
    
  
    <div id="navbar-header"> </div>
    <div id="sidebar-container"> 
  
    </div>
  <!-- Main content container outside of header -->
  <div class="container">

  <div class="row"><!---row Mark-->
   
      <div class="column visits-column">
        <div class="total-visits">
            <div class="total-visits-number">12,321</div>
            <div>Total Visits</div>
        </div>
        <div class="visits-row">
            <div>
                <div class="visit-count">10,653</div>
                <div class="visit-label">Guest Visits</div>
            </div>
            <div>
                <div class="visit-count">1,668</div>
                <div class="visit-label">User Visits</div>
            </div>
        </div>
      
    </div><!--Mark-->
    
    
    <div class="top-authors-container">
      <h3>Top Authors</h3>
      <div class="authors-list">
          <div class="author">
            <div class="author-image" style="background-image: url('./Components/img/samp_pfp.jpg');"></div>
              <div class="author-name">Yalwa Smith</div>
              <div class="author-visits">521 visits</div>
          </div>
          <div class="author">
              <div class="author-image" style="background-image: url('./Components/img/samp_pfp.jpg');"></div>
              <div class="author-name">Charilaos James</div>
              <div class="author-visits">470 visits</div>
          </div>
          <div class="author">
              <div class="author-image" style="background-image: url('./Components/img/samp_pfp.jpg');"></div>
              <div class="author-name">Gunnarr Stuart</div>
              <div class="author-visits">455 visits</div>
          </div>
          <div class="author">
              <div class="author-image" style="background-image: url('./Components/img/samp_pfp.jpg');"></div>
              <div class="author-name">Anna Burkhard</div>
              <div class="author-visits">400 visits</div>
          </div>
          <div class="author">
              <div class="author-image" style="background-image: url('./Components/img/samp_pfp.jpg');"></div>
              <div class="author-name">Kay Ashlyn</div>
              <div class="author-visits">399 visits</div>
          </div>
      </div>
  </div>
   
    
  </div><!--row close Mark-->

  <div class="row"><!--row Open Mark-->
    <div class="column"><!--Mark-->
      
      <table class="most-visited-table">
        <h3 class="most-visited-heading">Most Visited Works</h3>
        <div class="most-visited-filter">
          <label for="most-visited-time-period" class="filter-label">Time period:</label>
          <select id="most-visited-time-period" class="time-filter">
            <option value="1">Daily</option>
            <option value="3">Last 3 days</option>
            <option value="7" selected>Last 7 days</option>
            <option value="30">Last month</option>
            <option value="0">All time</option>
          </select>
        </div>
        <thead>
          <tr>
            <th>Cover</th>
            <th>Details</th>
            <th>Visits</th>
          </tr>
        </thead>
        <tbody id="most-visited-works-tbody">
          <tr>
            <td colspan="3" class="loading-data">
              <div class="loading-spinner"></div>
              <p>Loading most visited works...</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div><!--Mark-->

    <div class="column"><!--Mark-->
      <div class="works-summary">
        <div class="works-by-type">
          <div class="work-count">
            <div class="work-icon confluence">
                <img src="/admin/Components/icons/Category-icons/confluence.png" alt="Confluence Icon"> 
            </div>
            <span class="work-type confluence-text">Confluence</span>
            <span class="count">Loading...</span>
            <span class="label">Works</span>
        </div>
        <div class="work-count">
            <div class="work-icon dissertation">
                <img src="/admin/Components/icons/Category-icons/dissertation.png" alt="Dissertation Icon">
            </div>
            <span class="work-type dissertation-text">Dissertation</span>
            <span class="count">Loading...</span>
            <span class="label">Works</span>
        </div>
        <div class="work-count">
            <div class="work-icon thesis">
                <img src="/admin/Components/icons/Category-icons/thesis.png" alt="Thesis Icon">
            </div>
            <span class="work-type thesis-text">Thesis</span>
            <span class="count">Loading...</span>
            <span class="label">Works</span>
        </div>
        <div class="work-count">
            <div class="work-icon synergy">
                <img src="/admin/Components/icons/Category-icons/synergy.png" alt="Synergy Icon">
            </div>
            <span class="work-type synergy-text">Synergy</span>
            <span class="count">Loading...</span>
            <span class="label">Works</span>
        </div>
        </div>
        <div class="total-works">
          <span class="total-count">Loading...</span>
          <span class="total-label">Works</span>
        </div>
      </div>
      <div class="trending-keywords">
        <h3 class="trending-keywords-heading">Trending Keywords</h3>
        <div class="keywords-list">
          <!-- Keywords will be loaded dynamically by trending-keywords.js -->
          <div class="loading-message" style="width: 100%; text-align: center; color: #6b7280;">
            <div class="loading-spinner"></div>
            <p>Loading trending keywords...</p>
          </div>
        </div>
      </div>
  
        <div class="chart-container">
            <div class="chart-header">
                <h3>Total Visitors</h3>
                <div>
                    <button class="active" data-period="daily">Daily</button>
                    <button data-period="weekly">Weekly</button>
                    <button data-period="monthly">Monthly</button>
                </div>
            </div>
            <canvas id="visitorChart"></canvas>
        </div>
        

  </div><!--row close Mark-->

  <script>
    // Use a minimal handler that just delegates to the sidebar implementation
    window.handleLogout = function(event) {
      if (typeof window.sidebarHandleLogout === 'function') {
        return window.sidebarHandleLogout(event);
      }
      
      // Only if the sidebar handler isn't available, use a minimal approach
      // that respects the server's redirect
      if (event) event.preventDefault();
      localStorage.clear();
      sessionStorage.clear();
      document.cookie.split(";").forEach(c => {
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
      });
      
      // Use the server's logout endpoint and allow redirect to be followed
      fetch('/logout', {
        method: 'POST',
        credentials: 'include',
        redirect: 'follow'
      })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          window.location.href = '/index.html?nocache=' + new Date().getTime();
        }
      })
      .catch(() => {
        window.location.href = '/index.html?nocache=' + new Date().getTime();
      });
    }

    // Load sidebar and navbar without adding duplicate event listeners
    fetch('/admin/Components/side_bar.html')
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to load sidebar: ${response.status}`);
        }
        return response.text();
      })
      .then(data => {
        document.getElementById('sidebar-container').innerHTML = data;
        // No event handlers added here - side_bar.js will handle this
      })
      .catch(error => console.error('Error loading sidebar:', error));

    fetch('/admin/Components/navbar_header.html')
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to load navbar: ${response.status}`);
        }
        return response.text();
      })
      .then(data => {
        document.getElementById('navbar-header').innerHTML = data;
      })
      .catch(error => console.error('Error loading navbar:', error));
  </script>

  </div>
  
</body>
</html>