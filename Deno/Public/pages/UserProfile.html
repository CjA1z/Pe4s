<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        :root {
            --theme-gold: #FDB813;
            --theme-gold-darker: #EAA10F;
            --theme-gold-darkest: #D48F0D;
            --theme-gold-light-bg: rgba(253, 184, 19, 0.2);
            --theme-gold-lighter-bg: rgba(253, 184, 19, 0.1);
            --theme-green-dark: #006A4E;
            --theme-green-darker-text: #00523D;
            --theme-green-light-bg: rgba(0, 106, 78, 0.3);
            --theme-green-lighter-bg: rgba(0, 106, 78, 0.15);
            --theme-green-border: rgba(0, 106, 78, 0.7);
            --pastel-gold: #FFF5CC;
            --pastel-green: #D0EAD0; 
            --neutral-border-color: #e5e7eb; 
            --input-border-color: #d1d5db; 
            --placeholder-text-color: #9ca3af; 
            --off-white-text: #F5F5F5;
            --card-shadow-color: rgba(0, 106, 78, 0.08); 
            --card-shadow-hover-color: rgba(0, 106, 78, 0.12);
            --muted-text-color: #6b7280; /* Tailwind gray-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to bottom right, #fdfae8, #e6f4ea);
            color: #1f2937; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem 1rem;
            margin-top: 1rem; /* Add space below navbar */
        }
        .profile-card {
            background-color: #ffffff;
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px var(--card-shadow-color), 0 2px 4px -2px var(--card-shadow-color), 0 0 0 1px var(--neutral-border-color);
            transition: box-shadow 0.3s ease-in-out;
        }
        .profile-card:hover {
             box-shadow: 0 10px 15px -3px var(--card-shadow-hover-color), 0 4px 6px -2px var(--card-shadow-hover-color), 0 0 0 1px var(--theme-green-border);
        }
        .image-preview-container {
            width: 150px; height: 150px; border-radius: 50%;
            overflow: hidden; margin-bottom: 0.75rem; 
            border: 4px solid var(--theme-gold); 
            box-shadow: 0 5px 12px -2px rgba(253, 184, 19, 0.3), 0 3px 7px -3px rgba(253, 184, 19, 0.2); 
            background-color: #f3f4f6; position: relative; cursor: pointer; 
        }
        #profilePicturePreview {
            display: block; width: 100%; height: 100%;
            object-fit: cover; transition: filter 0.3s ease, transform 0.3s ease; 
        }
        .image-preview-container:hover #profilePicturePreview {
            filter: brightness(0.75); transform: scale(1.05); 
        }
        .edit-picture-hover-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); color: white;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
            border-radius: 50%; z-index: 5; cursor: pointer; 
        }
        .image-preview-container:hover .edit-picture-hover-overlay {
            opacity: 1; visibility: visible; transition-delay: 0s; 
        }
        .edit-picture-hover-overlay i { font-size: 1.75rem; margin-bottom: 0.375rem; }
        .edit-picture-hover-overlay span { font-size: 0.9375rem; font-weight: 500; }
        .profile-info-text {
            font-size: 0.875rem; color: var(--muted-text-color);
            text-align: center; line-height: 1.4;
            user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; 
        }
        .profile-info-text strong { color: var(--theme-green-darker-text); font-weight: 500; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.65); 
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content {
            background-color: white; border-radius: 0.75rem; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.1);
            width: 90%; max-width: 600px; /* Slightly wider modal for preview */
            text-align: left; overflow: hidden; 
        }
        .modal-header {
            background-color: var(--pastel-green); padding: 1rem 1.25rem; 
            border-bottom: 1px solid var(--neutral-border-color);
        }
        .modal-title {
            font-size: 1.25rem; font-weight: 600; 
            color: var(--theme-green-darker-text); text-align: center;
        }
        .modal-body { 
            padding: 1.25rem; 
            display: flex; /* Use flexbox for side-by-side layout */
            gap: 1.25rem; /* Space between cropper and preview */
            align-items: flex-start; /* Align items at the top */
        }
        #cropperImageModalContainer { 
            flex: 1; /* Allow cropper container to take available space */
            /* Max height removed, let it size naturally within flex */
            /* max-height: 350px;  */
            margin-bottom: 0; /* Removed bottom margin */
            overflow: hidden; background-color: #e9ecef; 
            border-radius: 0.375rem; border: 1px solid var(--input-border-color);
        }
        #cropperImageModalContainer img { display: block; max-width: 100%; }

        /* Live Preview Area in Modal */
        .modal-preview-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 150px; /* Fixed width matching the final preview */
            flex-shrink: 0; /* Prevent preview area from shrinking */
        }
        #liveCropPreview {
            width: 150px; 
            height: 150px; 
            border-radius: 50%; 
            background-color: #f0f0f0; /* Placeholder background */
            margin-bottom: 0.75rem; /* Space below preview */
            overflow: hidden; /* Ensure background image is clipped */
            background-size: cover; /* Scale the background image */
            background-position: center center;
            background-repeat: no-repeat;
            border: 2px solid var(--theme-green-border); /* Add a border */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .modal-preview-area p {
            font-size: 0.8rem;
            color: var(--muted-text-color);
            text-align: center;
        }

        .modal-actions {
            margin-top: 0; padding: 1rem 1.25rem; /* Adjusted padding */
            display: flex; justify-content: flex-end; gap: 0.75rem; 
            border-top: 1px solid var(--neutral-border-color); 
        }
        .crop-action-button { 
            font-size: 0.875rem; padding: 0.625rem 1.25rem; border-radius: 0.375rem; 
            cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            border: 1px solid transparent; display: inline-flex; align-items: center; font-weight: 500;
        }
        .crop-action-button.apply {
            background-color: var(--theme-green-dark); color: var(--off-white-text);
            border-color: var(--theme-green-darker-text);
        }
        .crop-action-button.apply:hover { background-color: var(--theme-green-darker-text); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .crop-action-button.cancel {
            background-color: #f8f9fa; color: #4b5563; 
            border-color: var(--input-border-color);
        }
        .crop-action-button.cancel:hover { background-color: #f3f4f6; border-color: #9ca3af; }
        .crop-action-button i { margin-right: 0.375rem; }

        input[type="file"] { display: none; }
        .form-input { 
            margin-top: 0.25rem; display: block; width: 100%;
            padding: 0.625rem 0.875rem; font-size: 0.875rem;
            border: 1px solid var(--input-border-color); border-radius: 0.375rem;
            background-color: #f9fafb; transition: border-color 0.2s ease, box-shadow 0.2s ease;
            color: var(--theme-green-darker-text);
        }
        .form-input:focus {
            outline: none; border-color: var(--theme-gold);
            box-shadow: 0 0 0 3px var(--theme-gold-lighter-bg), inset 0 1px 2px rgba(0,0,0,0.075); 
            background-color: white;
        }
        .input-icon-wrapper { position: relative; }
        .input-icon { 
            position: absolute; top: 50%; right: 0.75rem; 
            transform: translateY(-50%); color: var(--placeholder-text-color); 
        }
        .password-toggle-icon {
             position: absolute; top: 50%; right: 0.75rem; 
             transform: translateY(-50%); color: var(--placeholder-text-color); 
             cursor: pointer; padding: 0.25rem; 
        }
        .password-toggle-icon:hover { color: var(--theme-green-dark); }

        .save-changes-button {
            background-image: linear-gradient(to right, var(--theme-gold) 0%, var(--theme-gold-darker) 50%, var(--theme-gold) 100%);
            background-size: 200% auto; color: var(--off-white-text);
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600;
            font-size: 0.9375rem; line-height: 1.375rem;
            transition: background-position 0.4s ease-out, color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            border: none; display: inline-flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 2px 5px rgba(228, 152, 15, 0.2), 0 1px 3px rgba(0,0,0,0.08); 
            animation: moveGradient 4s linear infinite;
        }
        @keyframes moveGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .save-changes-button:hover {
            background-position: right center; color: var(--off-white-text);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 10px rgba(234, 161, 15, 0.3), 0 2px 6px rgba(234, 161, 15, 0.2);
        }
        .save-changes-button:active {
            transform: translateY(0px) scale(0.98);
            background-image: linear-gradient(to right, var(--theme-gold-darker) 0%, var(--theme-gold-darkest) 50%, var(--theme-gold-darker) 100%);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .save-changes-button:focus-visible { 
            outline: none; box-shadow: 0 0 0 3px var(--theme-gold-light-bg), 0 4px 10px rgba(234, 161, 15, 0.3);
        }
        .save-changes-button i { margin-right: 0.5rem; }
        .message-box {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1001; opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            pointer-events: none; font-weight: 500;
        }
        .message-box.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
        .message-box.success {
            background-color: var(--pastel-green); color: var(--theme-green-darker-text);
            border: 1px solid var(--theme-green-dark);
        }
        .message-box.error {
            background-color: var(--pastel-gold); color: var(--theme-gold-darkest);
            border: 1px solid var(--theme-gold-darker);
        }
        .form-label {
            display: block; font-size: 0.875rem; font-weight: 600;
            color: var(--theme-green-darker-text); margin-bottom: 0.375rem; 
        }
        .page-title {
            font-size: 1.875rem; font-weight: 700; color: var(--theme-green-dark); 
            margin-bottom: 2rem; text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 106, 78, 0.1); 
        }
         @media (min-width: 640px) { .page-title { font-size: 2.25rem; margin-bottom: 2.5rem; } }
        .hidden { display: none !important; }
        #newPasswordFieldsContainer {
            overflow: hidden;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, margin-top 0.4s ease-out;
            max-height: 0; opacity: 0; margin-top: 0 !important; 
        }
        #newPasswordFieldsContainer.visible {
            max-height: 300px; opacity: 1; margin-top: 1.5rem !important; 
        }
        .cropper-view-box, .cropper-face { border-radius: 50%; }
        #cropperImageInModal.cropper-hidden { max-width: 100%; max-height: 350px; }
        hr { border: none; height: 1px; background-color: var(--neutral-border-color); margin: 1.5rem 0; }
        
        /* Navbar integration styles */
        #navbar-container {
            position: relative;
            z-index: 30; /* Lower than modal (which is 1000) but higher than other content */
        }
        
        /* Ensure modals appear above navbar */
        .modal-overlay {
            z-index: 1000; /* Higher than navbar */
        }
        
        /* Message box should appear above everything */
        .message-box {
            z-index: 1001; /* Higher than both navbar and modal */
        }
        
        /* Navbar dropdown styles */
        #dropdown-menu {
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }
        
        .dropdown-greeting-container {
            padding: 1rem 1.25rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .greeting-text {
            display: block;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .greeting-name {
            display: block;
            font-weight: 600;
            font-size: 1.125rem;
            color: #111827;
            margin-top: 0.25rem;
        }
        
        .dropdown-divider {
            height: 1px;
            margin: 0.5rem 0;
            background-color: #e5e7eb;
        }
        
        .count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 1.25rem;
            height: 1.25rem;
            padding: 0 0.375rem;
            background-color: #fee2e2;
            color: #b91c1c;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
            line-height: 1;
            margin-left: 0.5rem;
        }
        
        /* Add styles for search bar placeholder */
        .search-bar-placeholder-text {
            margin-left: 0.5rem;
        }
        
        .search-bar-icon {
            color: var(--theme-green-dark);
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js" defer></script>
</head>
<body>
    <div id="navbarContainer">
        <!-- The navbar will be dynamically loaded here by navbar-loader.js -->
    </div>

    <div class="page-container">
    <div class="profile-card p-6 sm:p-8 md:p-10 w-full max-w-xl">
        <h1 class="page-title">User Profile</h1>

        <div class="flex flex-col items-center mb-6"> 
            <div class="image-preview-container">
                <img id="profilePicturePreview" 
                     src="" 
                     alt="Profile Picture"
                     data-use-avatar="true">
                <label for="profilePictureInput" class="edit-picture-hover-overlay" title="Change profile picture">
                        <i class="fas fa-camera"></i>
                        <span>Change<br>Photo</span>
                </label>
            </div>
            <input type="file" id="profilePictureInput" accept="image/*">
                <p class="profile-info-text">Upload a profile picture<br><strong>JPG or PNG, max 5MB</strong></p>

            <div class="mt-2 text-center space-y-1"> 
                <p id="displayUserId" class="profile-info-text">
                        <strong>ID:</strong> <span>Loading...</span>
                </p>
                <p id="displayEmail" class="profile-info-text">
                        <strong>Email:</strong> <span>Loading...</span>
                </p>
            </div>
        </div>

        <hr /> 

        <form id="profileForm" class="space-y-6 mt-6"> 
            <div>
                <label for="username" class="form-label">Username</label>
                <div class="input-icon-wrapper">
                    <input type="text" id="username" name="username" class="form-input" value="current_username">
                    <span class="input-icon"><i class="fas fa-pencil-alt"></i></span>
                </div>
            </div>

            <div>
                <label for="currentPassword" class="form-label">Current Password</label>
                <div class="input-icon-wrapper">
                    <input type="password" id="currentPassword" name="currentPassword" class="form-input" placeholder="Enter current password to change">
                     <span class="password-toggle-icon" onclick="togglePasswordVisibility('currentPassword', this)"><i class="fas fa-eye"></i></span>
                </div>
            </div>
            
            <div id="newPasswordFieldsContainer"> 
                <div class="space-y-6"> 
                    <div>
                        <label for="newPassword" class="form-label">New Password</label>
                         <div class="input-icon-wrapper">
                            <input type="password" id="newPassword" name="newPassword" class="form-input" placeholder="Enter new password">
                            <span class="password-toggle-icon" onclick="togglePasswordVisibility('newPassword', this)"><i class="fas fa-eye"></i></span>
                        </div>
                    </div>
                     <div>
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                         <div class="input-icon-wrapper">
                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" placeholder="Confirm new password">
                             <span class="password-toggle-icon" onclick="togglePasswordVisibility('confirmPassword', this)"><i class="fas fa-eye"></i></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="pt-6"> 
                <button type="submit" class="w-full save-changes-button">
                    <i class="fas fa-save"></i>Save Changes
                </button>
            </div>
        </form>
        </div>
    </div>

    <div id="cropModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                 <h3 class="modal-title">Edit Profile Picture</h3>
            </div>
            <div class="modal-body">
                <div id="cropperImageModalContainer">
                    <img id="cropperImageInModal" src="#" alt="Image to crop">
                </div>
                <div class="modal-preview-area">
                    <div id="liveCropPreview"></div>
                    <p>Live Preview</p>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancelCropModalButton" class="crop-action-button cancel">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button id="applyCropModalButton" class="crop-action-button apply">
                    <i class="fas fa-check"></i> Apply Crop
                </button>
            </div>
        </div>
    </div>

    <div id="messageBox" class="message-box">
        <span id="messageText"></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js" defer></script>

    <!-- Navbar Manager: Dynamically loads the appropriate navbar based on user role -->
    <script src="/Components/js/navbar-loader.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Debug logging
            console.log('DEBUG: Starting navbar initialization');
            console.log('DEBUG: localStorage userInfo =', localStorage.getItem('userInfo'));
            console.log('DEBUG: sessionStorage userInfo =', sessionStorage.getItem('userInfo'));
            console.log('DEBUG: Checking NavbarModule constants:');
            if (window.NavbarModule) {
                console.log('DEBUG: NavbarModule found');
                
                // Fix path case sensitivity issues
                if (window.NavbarModule.USER_NAVBAR_URL === '/components/NavBar/user-Navbar.html') {
                    window.NavbarModule.USER_NAVBAR_URL = '/Components/NavBar/user-Navbar.html';
                    console.log('DEBUG: Fixed USER_NAVBAR_URL case sensitivity');
                }
            } else {
                console.error('DEBUG: NavbarModule not found - script might not be loading correctly');
            }
            
            // Initialize the navbar
            if (window.NavbarModule) {
                window.NavbarModule.init();

                // Add element existence check after initialization
                setTimeout(function() {
                    console.log("DEBUG: Checking if navbar elements exist:");
                    const searchButton = document.getElementById('search-open-button');
                    console.log("- Search button exists:", !!searchButton);
                    if (searchButton) {
                        console.log("  - Search button display:", window.getComputedStyle(searchButton).display);
                        console.log("  - Search button visibility:", window.getComputedStyle(searchButton).visibility);
                        console.log("  - Search button z-index:", window.getComputedStyle(searchButton).zIndex);
                    }
                    
                    const userAuthContainer = document.getElementById('user-auth-container');
                    console.log("- User auth container exists:", !!userAuthContainer);
                    if (userAuthContainer) {
                        console.log("  - User auth container children count:", userAuthContainer.children.length);
                        console.log("  - User auth container display:", window.getComputedStyle(userAuthContainer).display);
                        console.log("  - User auth container visibility:", window.getComputedStyle(userAuthContainer).visibility);
                    }
                    
                    const profileBadgeContainer = document.getElementById('profile-badge-container-dynamic');
                    console.log("- Profile badge container exists:", !!profileBadgeContainer);
                    
                    const navbar = document.querySelector('nav');
                    console.log("- Navbar exists:", !!navbar);
                    if (navbar) {
                        console.log("  - Navbar classes:", navbar.className);
                        console.log("  - Navbar display:", window.getComputedStyle(navbar).display);
                        console.log("  - Navbar z-index:", window.getComputedStyle(navbar).zIndex);
                    }
                    
                    // Fix any potential CSS issues on this page
                    if (userAuthContainer) {
                        userAuthContainer.style.display = 'block';
                        userAuthContainer.style.visibility = 'visible';
                        userAuthContainer.style.zIndex = '100';
                    }
                    
                    if (searchButton) {
                        searchButton.style.display = 'flex';
                        searchButton.style.visibility = 'visible';
                    }
                    
                    // Implement manual creation of profile badge and search button if they don't exist
                    const mdFlex = document.querySelector('.md\\:flex.md\\:items-center.md\\:ml-6');
                    if (mdFlex) {
                        console.log("Found navbar container, checking if elements need manual creation");
                        
                        // Check if search button exists and create it if not
                        if (!searchButton) {
                            console.log("Creating search button manually");
                            const searchButtonContainer = document.createElement('div');
                            searchButtonContainer.className = 'ml-4 flex items-center space-x-4';
                            
                            const newSearchButton = document.createElement('button');
                            newSearchButton.id = 'search-open-button';
                            newSearchButton.type = 'button';
                            newSearchButton.className = 'focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-green-600 flex items-center';
                            newSearchButton.innerHTML = `
                                <svg class="search-bar-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                                </svg>
                                <span class="search-bar-placeholder-text">Search (Ctrl+K)</span>
                            `;
                            
                            searchButtonContainer.appendChild(newSearchButton);
                            mdFlex.appendChild(searchButtonContainer);
                            
                            // Add event listener to the search button
                            newSearchButton.addEventListener('click', function() {
                                if (typeof window.openSearch === 'function') {
                                    window.openSearch();
                                } else {
                                    console.error("openSearch function not found");
                                }
                            });
                        }
                        
                        // Check if user auth container exists with children
                        if (!userAuthContainer || userAuthContainer.children.length === 0) {
                            console.log("Creating profile badge manually");
                            // Create a new container if needed
                            if (!userAuthContainer) {
                                userAuthContainer = document.createElement('div');
                                userAuthContainer.id = 'user-auth-container';
                                userAuthContainer.className = 'relative inline-block text-left';
                                mdFlex.appendChild(userAuthContainer);
                            }
                            
                            // Create profile badge
                            try {
                                // Get user info
                                const userInfo = JSON.parse(sessionStorage.getItem('userInfo'));
                                if (userInfo && userInfo.isLoggedIn) {
                                    const user = {
                                        id: userInfo.id,
                                        username: userInfo.username,
                                        email: userInfo.email,
                                        first_name: userInfo.first_name,
                                        last_name: userInfo.last_name,
                                        display_name: userInfo.display_name || (userInfo.first_name ? `${userInfo.first_name} ${userInfo.last_name || ''}` : userInfo.username)
                                    };
                                    
                                    // Create profile badge container
                                    const profileBadgeContainer = document.createElement('div');
                                    profileBadgeContainer.id = 'profile-badge-container-dynamic';
                                    profileBadgeContainer.className = 'relative inline-block text-left';
                                    
                                    // Create button
                                    const button = document.createElement('button');
                                    button.type = 'button';
                                    button.id = 'profile-badge-button';
                                    button.className = 'flex items-center justify-center w-10 h-10 bg-green-600 rounded-full hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-green-600 profile-initials text-lg select-none';
                                    
                                    // Generate initials
                                    let initials = '';
                                    if (user.first_name && user.last_name) {
                                        initials = user.first_name.charAt(0) + user.last_name.charAt(0);
                                    } else if (user.first_name) {
                                        initials = user.first_name.charAt(0);
                                    } else if (user.username) {
                                        initials = user.username.charAt(0);
                                    } else {
                                        initials = 'U';
                                    }
                                    
                                    button.innerHTML = `<span class="text-white font-medium">${initials.toUpperCase()}</span>`;
                                    
                                    // Create dropdown menu
                                    const dropdownMenu = document.createElement('div');
                                    dropdownMenu.id = 'dropdown-menu';
                                    dropdownMenu.className = 'dropdown-menu origin-top-right absolute right-0 mt-2 w-60 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none opacity-0 transform scale-95 pointer-events-none z-50 select-none';
                                    
                                    // Populate dropdown
                                    dropdownMenu.innerHTML = `
                                        <div class="dropdown-greeting-container" role="none">
                                            <span id="greeting-part" class="greeting-text">Hello! ðŸ‘‹</span>
                                            <span id="user-name-part" class="greeting-name">${user.display_name || user.first_name || user.username}</span>
                                        </div>
                                        <div class="py-1" role="none">
                                            <a href="/pages/userProfile.html" class="group text-gray-700 flex items-center px-4 py-2 text-sm hover:bg-amber-100 hover:text-green-800 rounded-md mx-1" role="menuitem">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                                                </svg>
                                                Profile
                                            </a>
                                            <a href="/pages/userHistory.html" class="group text-gray-700 flex items-center px-4 py-2 text-sm hover:bg-amber-100 hover:text-green-800 rounded-md mx-1" role="menuitem">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                History
                                            </a>
                                            <button type="button" id="logout-button-desktop" class="group text-red-600 flex items-center px-4 py-2 text-sm hover:bg-red-200 hover:text-red-800 rounded-md mx-1 w-full text-left" role="menuitem">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                                                </svg>
                                                Log Out
                                            </button>
                                        </div>
                                    `;
                                    
                                    // Assemble and append
                                    profileBadgeContainer.appendChild(button);
                                    profileBadgeContainer.appendChild(dropdownMenu);
                                    userAuthContainer.appendChild(profileBadgeContainer);
                                    
                                    // Add toggle functionality
                                    button.addEventListener('click', function(event) {
                                        event.stopPropagation();
                                        const isOpen = dropdownMenu.classList.contains('opacity-100');
                                        
                                        if (isOpen) {
                                            dropdownMenu.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                                            dropdownMenu.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                                        } else {
                                            dropdownMenu.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                                            dropdownMenu.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');
                                        }
                                    });
                                    
                                    // Close dropdown when clicking outside
                                    document.addEventListener('click', function(event) {
                                        if (profileBadgeContainer && !profileBadgeContainer.contains(event.target)) {
                                            if (dropdownMenu.classList.contains('opacity-100')) {
                                                dropdownMenu.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                                                dropdownMenu.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                                            }
                                        }
                                    });
                                    
                                    // Add logout functionality
                                    const logoutButton = document.getElementById('logout-button-desktop');
                                    if (logoutButton) {
                                        logoutButton.addEventListener('click', function() {
                                            if (typeof window.logout === 'function') {
                                                window.logout();
                                            } else {
                                                // Fallback logout
                                                sessionStorage.removeItem('userInfo');
                                                localStorage.removeItem('userInfo');
                                                window.location.href = '/index.html?logout=true';
                                            }
                                        });
                                    }
                                }
                            } catch (error) {
                                console.error("Error creating profile badge:", error);
                            }
                        }
                    } else {
                        console.warn("Could not find navbar container for manual element creation");
                    }
                }, 1000); // Check after 1 second

                // Add event listener to force navbar refresh when userInfo changes
                window.addEventListener('storage', function(event) {
                    if (event.key === 'userInfo') {
                        console.log('User info changed, refreshing navbar...');
                        window.NavbarModule.init();
                    }
                });
                
                // Force refresh on page load if coming from login
                if (document.referrer.includes('log-in.html')) {
                    console.log('Coming from login page, refreshing navbar...');
                    setTimeout(() => window.NavbarModule.init(), 100);
                }
            } else {
                console.error('NavbarModule not found! Make sure navbar-loader.js is loaded correctly.');
            }
            
            // Record page visit
            if (typeof window.recordPageVisit === 'function') {
                window.recordPageVisit();
            }
        });
    </script>
    
    <!-- User Profile Page Script -->
    <script>
        // --- Constants ---
        const DEFAULT_PROFILE_PICTURE_URL = ""; // Will be generated dynamically based on user's name
        const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024; // 5MB
        const WEBP_OUTPUT_QUALITY = 0.8; 
        const CROPPED_IMAGE_SIZE = 150; 
        const API_ENDPOINTS = {
            profile: '/api/user/profile',
            updateProfile: '/api/user/profile/update',
            updatePassword: '/api/user/profile/password',
            uploadProfilePicture: '/api/user/profile/picture'
        };

        // --- DOM Elements ---
        const profilePicturePreview = document.getElementById('profilePicturePreview'); 
        
        // Setup image error handler after the function is defined
        if (profilePicturePreview) {
            profilePicturePreview.onerror = function() {
                if (!this.getAttribute('data-error-handled')) {
                    this.setAttribute('data-error-handled', 'true');
                    const name = userData?.first_name || userData?.username || 'User';
                    this.src = generateInitialAvatar(name);
                }
            };
        }
        
        const profilePictureInput = document.getElementById('profilePictureInput'); 
        const profileForm = document.getElementById('profileForm');
        const usernameInput = document.getElementById('username');
        const displayUserId = document.getElementById('displayUserId').querySelector('span'); 
        const displayEmail = document.getElementById('displayEmail').querySelector('span'); 
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const newPasswordFieldsContainer = document.getElementById('newPasswordFieldsContainer'); 
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const cropModal = document.getElementById('cropModal'); 
        const cropperImageInModal = document.getElementById('cropperImageInModal'); 
        const applyCropModalButton = document.getElementById('applyCropModalButton');
        const cancelCropModalButton = document.getElementById('cancelCropModalButton');
        const liveCropPreview = document.getElementById('liveCropPreview');
        const saveChangesButton = document.querySelector('.save-changes-button');

        // --- State ---
        let cropper = null; 
        let newProfilePicDataUrl = null; 
        let userData = null;
        let isLoading = false;

        // --- Helper Functions ---
        
        // Generate an initial-based avatar for the user
        function generateInitialAvatar(name) {
            name = name || 'User';
            const initial = name.charAt(0).toUpperCase();
            
            // Generate a consistent color based on the name
            const colors = [
                '#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#34495e',
                '#16a085', '#27ae60', '#2980b9', '#8e44ad', '#2c3e50',
                '#f1c40f', '#e67e22', '#e74c3c', '#95a5a6', '#f39c12',
                '#d35400', '#c0392b', '#bdc3c7', '#7f8c8d'
            ];
            
            // Hash the name to get a consistent color
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const colorIndex = Math.abs(hash) % colors.length;
            const bgColor = colors[colorIndex];
            
            // Create SVG
            return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150'%3E%3Ccircle cx='75' cy='75' r='75' fill='${encodeURIComponent(bgColor)}'/%3E%3Ctext x='50%25' y='50%25' dy='.1em' font-size='75' font-weight='bold' text-anchor='middle' dominant-baseline='middle' font-family='Arial' fill='%23FFFFFF'%3E${initial}%3C/text%3E%3C/svg%3E`;
        }

        // --- API Functions ---
        
        // Get auth token from storage
        function getAuthToken() {
            try {
                const userInfo = JSON.parse(sessionStorage.getItem('userInfo'));
                return userInfo?.token || null;
            } catch (error) {
                console.error('Error getting auth token:', error);
                return null;
            }
        }
        
        // Check if user is authenticated
        function checkAuthentication() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                return false;
            }
            return true;
        }
        
        // Fetch user profile data from backend
        async function fetchUserProfile() {
            // Get the token directly from sessionStorage
            let userInfo;
            try {
                userInfo = JSON.parse(sessionStorage.getItem('userInfo'));
                if (!userInfo || !userInfo.token || !userInfo.isLoggedIn) {
                    console.error('Invalid or missing user authentication data');
                    showMessage('Authentication error. Please log in again.', 'error');
                    return null;
                }
                
                // Start loading indicator
                setLoading(true);
                
                // Add slight delay to ensure token is available
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Fetch user profile
                const userId = userInfo.id || '';
                const response = await fetch(`${API_ENDPOINTS.profile}?userId=${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userInfo.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.warn('Using session data as fallback due to auth error');
                        // Use userInfo data from sessionStorage as fallback
                        return {
                            id: userInfo.id,
                            username: userInfo.username,
                            email: userInfo.email,
                            first_name: userInfo.first_name,
                            last_name: userInfo.last_name
                        };
                    } else {
                        throw new Error(`Failed to fetch profile: ${response.status}`);
                    }
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching user profile:', error);
                showMessage('Failed to load profile data. Using session data instead.', 'error');
                
                // Use userInfo data from sessionStorage as fallback
                if (userInfo) {
                    return {
                        id: userInfo.id,
                        username: userInfo.username,
                        email: userInfo.email,
                        first_name: userInfo.first_name,
                        last_name: userInfo.last_name
                    };
                }
                return null;
            } finally {
                setLoading(false);
            }
        }
        
        // Update profile information
        async function updateUserProfile(formData) {
            if (!checkAuthentication()) return;
            
            // Get the token directly from sessionStorage
            let userInfo;
            try {
                userInfo = JSON.parse(sessionStorage.getItem('userInfo'));
                if (!userInfo || !userInfo.token || !userInfo.isLoggedIn) {
                    throw new Error('Invalid or missing user authentication data');
                }
            } catch (error) {
                console.error('Error parsing session user data:', error);
                showMessage('Authentication error. Please log in again.', 'error');
                return null;
            }
            
            try {
                setLoading(true);
                // Include userId in the URL
                const userId = userInfo.id || '';
                const response = await fetch(`${API_ENDPOINTS.updateProfile}?userId=${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${userInfo.token}`
                        // Content-Type is not set because FormData sets it automatically with boundary
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Failed to update profile: ${response.status}`);
                }
                
                const data = await response.json();
                setLoading(false);
                return data;
            } catch (error) {
                console.error('Error updating profile:', error);
                showMessage(error.message || 'Failed to update profile. Please try again.', 'error');
                setLoading(false);
                return null;
            }
        }
        
        // Update user password
        async function updateUserPassword(currentPassword, newPassword) {
            if (!checkAuthentication()) return;
            
            // Get the token directly from sessionStorage
            let userInfo;
            try {
                userInfo = JSON.parse(sessionStorage.getItem('userInfo'));
                if (!userInfo || !userInfo.token || !userInfo.isLoggedIn) {
                    throw new Error('Invalid or missing user authentication data');
                }
            } catch (error) {
                console.error('Error parsing session user data:', error);
                showMessage('Authentication error. Please log in again.', 'error');
                return null;
            }
            
            try {
                setLoading(true);
                // Include userId in the URL
                const userId = userInfo.id || '';
                const response = await fetch(`${API_ENDPOINTS.updatePassword}?userId=${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${userInfo.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Failed to update password: ${response.status}`);
                }
                
                setLoading(false);
                return true;
            } catch (error) {
                console.error('Error updating password:', error);
                showMessage(error.message || 'Failed to update password. Please try again.', 'error');
                setLoading(false);
                return false;
            }
        }
        
        // Upload profile picture
        async function uploadProfilePicture(imageBlob) {
            if (!checkAuthentication()) return;
            
            // Get the token directly from sessionStorage
            let userInfo;
            try {
                userInfo = JSON.parse(sessionStorage.getItem('userInfo'));
                if (!userInfo || !userInfo.token || !userInfo.isLoggedIn) {
                    throw new Error('Invalid or missing user authentication data');
                }
            } catch (error) {
                console.error('Error parsing session user data:', error);
                showMessage('Authentication error. Please log in again.', 'error');
                return null;
            }
            
            const formData = new FormData();
            formData.append('profilePicture', imageBlob, 'profile.webp');
            
            try {
                setLoading(true);
                // Include userId in the URL
                const userId = userInfo.id || '';
                const response = await fetch(`${API_ENDPOINTS.uploadProfilePicture}?userId=${userId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${userInfo.token}`
                        // Content-Type is set automatically by FormData
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Failed to upload picture: ${response.status}`);
                }
                
                const data = await response.json();
                setLoading(false);
                return data.pictureUrl; // Return the URL of the uploaded picture
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                showMessage(error.message || 'Failed to upload profile picture. Please try again.', 'error');
                setLoading(false);
                return null;
            }
        }
        
        // --- UI Helper Functions ---
        
        function setLoading(loading) {
            isLoading = loading;
            saveChangesButton.disabled = loading;
            
            if (loading) {
                saveChangesButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            } else {
                saveChangesButton.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            }
        }

        // Load user data from backend and populate UI
        async function loadUserData() {
            const data = await fetchUserProfile();
            if (!data) return;
            
            userData = data;
            usernameInput.value = data.username || '';
            displayUserId.textContent = data.id || 'N/A';
            displayEmail.textContent = data.email || 'N/A';
            
            // Set profile picture if available or use initial-based avatar
            if (data.profilePictureUrl) {
                profilePicturePreview.src = data.profilePictureUrl;
            } else {
                // Generate initial-based avatar from user's name or username
                const name = data.first_name || data.username || 'User';
                const initialAvatar = generateInitialAvatar(name);
                profilePicturePreview.src = initialAvatar;
                console.log("Using generated avatar for user:", name);
            }
            
            // Reset form fields
            newProfilePicDataUrl = null; 
            currentPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            newPasswordFieldsContainer.classList.remove('visible'); 
        }

        function showMessage(message, type = 'success') {
            messageText.textContent = message;
            messageBox.className = `message-box ${type} show`; 
            setTimeout(() => messageBox.classList.remove('show'), 3000);
        }

        function openCropModal() {
            cropModal.classList.add('active');
            document.body.style.overflow = 'hidden'; 
        }

        function closeCropModal() {
            cropModal.classList.remove('active');
            if (cropper) { 
                cropper.destroy(); 
                cropper = null; 
            }
            profilePictureInput.value = ''; 
            document.body.style.overflow = ''; 
            liveCropPreview.style.backgroundImage = 'none';
        }

        function togglePasswordVisibility(fieldId, toggleButton) {
            const passwordInput = document.getElementById(fieldId);
            const icon = toggleButton.querySelector('i');
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                icon.classList.replace("fa-eye", "fa-eye-slash");
            } else {
                passwordInput.type = "password";
                icon.classList.replace("fa-eye-slash", "fa-eye");
            }
        }

        function dataURLtoBlob(dataUrl) {
            try {
                const arr = dataUrl.split(',');
                if (arr.length < 2) return null;
                const mimeMatch = arr[0].match(/:(.*?);/);
                if (!mimeMatch || mimeMatch.length < 2) return null;
                const mime = mimeMatch[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) { u8arr[n] = bstr.charCodeAt(n); }
                return new Blob([u8arr], { type: mime });
            } catch (e) { console.error("Error converting data URL to Blob:", e); return null; }
        }

        // --- Event Listeners ---

        profilePictureInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) { showMessage('Please select a valid image file.', 'error'); profilePictureInput.value = ''; return; }
                if (file.size > MAX_FILE_SIZE_BYTES) { showMessage(`Image size max ${MAX_FILE_SIZE_BYTES / 1024 / 1024}MB.`, 'error'); profilePictureInput.value = ''; return; }

                const reader = new FileReader();
                reader.onload = function(e) {
                    cropperImageInModal.src = e.target.result; 
                    openCropModal(); 
                    if (cropper) cropper.destroy();
                    
                    cropper = new Cropper(cropperImageInModal, {
                        aspectRatio: 1 / 1, viewMode: 1, dragMode: 'move', background: true, 
                        autoCropArea: 0.8, responsive: true, modal: false, guides: false,
                        center: false, highlight: false,
                        cropBoxMovable: true, cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        crop: function(event) {
                            if (!liveCropPreview) return;
                            const canvas = this.cropper.getCroppedCanvas({
                                width: CROPPED_IMAGE_SIZE,
                                height: CROPPED_IMAGE_SIZE,
                                imageSmoothingEnabled: false
                            });
                            if (canvas) {
                                liveCropPreview.style.backgroundImage = `url(${canvas.toDataURL()})`;
                            }
                        }
                    });
                };
                reader.onerror = () => { showMessage('Error reading file.', 'error'); profilePictureInput.value = ''; };
                reader.readAsDataURL(file);
            }
        });

        applyCropModalButton.addEventListener('click', function() {
            if (!cropper) return; 

            const croppedCanvas = cropper.getCroppedCanvas({
                width: CROPPED_IMAGE_SIZE, height: CROPPED_IMAGE_SIZE, 
                imageSmoothingEnabled: true, imageSmoothingQuality: 'high',
            });

            if (croppedCanvas) {
                try {
                    newProfilePicDataUrl = croppedCanvas.toDataURL('image/webp', WEBP_OUTPUT_QUALITY);
                    profilePicturePreview.src = newProfilePicDataUrl; 
                    showMessage('Crop applied. Click "Save Changes" to update.', 'success');
                } catch (error) {
                    console.error("WebP conversion error:", error);
                    showMessage('Could not convert to WebP. Using PNG.', 'error');
                    newProfilePicDataUrl = croppedCanvas.toDataURL('image/png');
                    profilePicturePreview.src = newProfilePicDataUrl; 
                }
            } else { showMessage('Could not get cropped image.', 'error'); }
            closeCropModal(); 
        });

        cancelCropModalButton.addEventListener('click', closeCropModal);
        cropModal.addEventListener('click', (event) => { if (event.target === cropModal) closeCropModal(); });

        currentPasswordInput.addEventListener('input', function() {
            if (currentPasswordInput.value.length > 0) {
                newPasswordFieldsContainer.classList.add('visible');
            } else {
                newPasswordFieldsContainer.classList.remove('visible');
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
            }
        });

        profileForm.addEventListener('submit', async function(event) { 
            event.preventDefault(); 
            if (isLoading) return;
            
            const newUsername = usernameInput.value.trim();
            const currentPassword = currentPasswordInput.value; 
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Validation
            if (!newUsername) { showMessage('Username cannot be empty.', 'error'); usernameInput.focus(); return; }
            if (newUsername.length < 3) { showMessage('Username must be at least 3 characters.', 'error'); usernameInput.focus(); return; }
            if (newUsername.length > 50) { showMessage('Username cannot exceed 50 characters.', 'error'); usernameInput.focus(); return; }

            const isChangingPassword = newPasswordFieldsContainer.classList.contains('visible') && (newPassword || confirmPassword);
            
            if (isChangingPassword) {
                if (!currentPassword) { showMessage('Please enter current password to change it.', 'error'); currentPasswordInput.focus(); return; }
                if (newPassword.length < 8) { showMessage('New password must be at least 8 characters.', 'error'); newPasswordInput.focus(); return; }
                if (newPassword !== confirmPassword) { showMessage('New passwords do not match.', 'error'); confirmPasswordInput.focus(); return; }
            }

            try {
                // Handle profile picture upload first if needed
                let newPictureUrl = null;
                if (newProfilePicDataUrl) {
                    const imageBlob = dataURLtoBlob(newProfilePicDataUrl);
                    if (imageBlob) {
                        newPictureUrl = await uploadProfilePicture(imageBlob);
                        if (!newPictureUrl) {
                            // Failed to upload picture but continue with other updates
                            showMessage('Profile picture upload failed, but continuing with other updates', 'error');
                        }
                    }
                }

                // Update profile information
            const formData = new FormData();
            formData.append('username', newUsername);
                if (newPictureUrl) {
                    formData.append('profilePictureUrl', newPictureUrl);
                }

                const profileUpdateResult = await updateUserProfile(formData);
                if (!profileUpdateResult) {
                    showMessage('Failed to update profile information', 'error');
                    return;
                }

                // Update password if needed
                let passwordUpdateSuccess = true;
            if (isChangingPassword) {
                    passwordUpdateSuccess = await updateUserPassword(currentPassword, newPassword);
                }

                // Final result
                if (profileUpdateResult && passwordUpdateSuccess) {
                    showMessage('Profile updated successfully!', 'success');
                    
                    // Refresh user data
                    await loadUserData();
                    
                    // Reset password fields
                    currentPasswordInput.value = ''; 
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    newPasswordFieldsContainer.classList.remove('visible'); 
                    newProfilePicDataUrl = null;
                } else if (profileUpdateResult) {
                    showMessage('Profile information updated, but password change failed', 'error');
                }
            } catch (error) {
                console.error('Error during profile update:', error);
                showMessage('An error occurred while updating profile', 'error');
            }
        });
        
        // --- Initial Page Load ---
        window.addEventListener('load', async function() {
            // Get user info directly from session storage as a starting point
            let sessionUserInfo;
            try {
                sessionUserInfo = JSON.parse(sessionStorage.getItem('userInfo'));
                if (!sessionUserInfo || !sessionUserInfo.isLoggedIn) {
                    console.warn('No valid user session found, redirecting to login');
                    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                // Initialize userData with session data as a fallback
                userData = {
                    id: sessionUserInfo.id,
                    username: sessionUserInfo.username,
                    email: sessionUserInfo.email,
                    first_name: sessionUserInfo.first_name,
                    last_name: sessionUserInfo.last_name
                };
                
                // Pre-populate form with session data while we fetch from API
                usernameInput.value = sessionUserInfo.username || '';
                displayUserId.textContent = sessionUserInfo.id || 'N/A';
                displayEmail.textContent = sessionUserInfo.email || 'N/A';
                
                // Generate initial avatar based on name from session
                const name = sessionUserInfo.first_name || sessionUserInfo.username || 'User';
                profilePicturePreview.src = generateInitialAvatar(name);
                console.log("Initial avatar generated for:", name);
            } catch (error) {
                console.error('Error reading session data', error);
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            // Try to load user data from API
            await loadUserData();
        });
    </script>
</body>
</html>
