<!DOCTYPE html>
<html data-wf-page="675c27fef76e00333b71cec9" data-wf-site="675c27fef76e00333b71ce4f" data-wf-status="1" lang="en">

<head>
    <meta charset="utf-8" />
    <title>Sample Document</title>
      <link href="../Components/css/webflow-style.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous" />
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
    <script
        type="text/javascript">WebFont.load({ google: { families: ["Inter:regular,500,600,700", "Libre Baskerville:regular,italic,700", "Volkhov:regular,italic,700,700italic", "Noto Serif:regular,italic,700,700italic"] } });</script>
    <script
        type="text/javascript">!function (o, c) { var n = c.documentElement, t = " w-mod-"; n.className += t + "js", ("ontouchstart" in o || o.DocumentTouch && c instanceof DocumentTouch) && (n.className += t + "touch") }(window, document);</script>
    <link href="images/favicon.png" rel="shortcut icon" type="image/x-icon" />
    <link href="images/untitled-20design-2-.png" rel="apple-touch-icon" />
    <meta name="robots" content="noindex">
</head>

<body>
    <div id="header"></div>

    <div class="page-wrapper"style="width: 1200px; max-width: 100%; margin: 0 auto;">
        <div class="section daek-page-header">
            <div class="container w-container">
                <div class="w-layout-grid ebook-page-grid">
                    <div class="text-box">
                        <h1 id="document-title" class="heading h1">Loading document...</h1>
                        <p id="document-author" class="paragraph large">Loading author information...</p>
                        <div id="document-year" class="text-block-16">-</div>
                    </div>
                    <div class="ebook-header-block"><img id="document-cover" sizes="100vw"
                            srcset="../images/peas-1-p-500.png 500w, ../images/peas-1-p-800.png 800w, ../images/peas-1-.png 1000w"
                            alt="" src="../images/peas-1-.png" loading="eager" class="ebook-cover" /></div>
                </div>
            </div>
        </div>
        <div class="section small">
            <div class="container w-container">
                <div class="w-layout-grid ebook-page-grid">
                    <div class="text-box _550px">
                        <h1 class="heading-2">Abstract</h1>
                        <p id="document-abstract" class="paragraph medium">Loading abstract...</p>
                        <div class="spacer _16"></div>
                        <div class="div-block">
                            <a id="read-document-link" href="#" class="button w-button">Read Document</a>
                            <a href="#" class="secondary-button w-button">Read Later</a>
                        </div>
                    </div>
                    <div class="ebook-mobile-block"><img alt="" loading="lazy" src="" class="ebook-cover" /></div>
                </div>
            </div>
            <div class="spacer _16"></div>
            <div class="spacer _16"></div>
            <div class="spacer _16"></div>
            <div class="div-block-2">
                <div class="w-layout-blockcontainer w-container">
                    <h1 class="heading-3">Document Information</h1>
                    <div class="w-layout-grid grid">
                        <div class="text-block-11">Title</div>
                        <div id="info-title">Loading...</div>
                        <div class="text-block-10">Author(s)
                        </div>
                        <div id="info-authors">Loading...</div>
                        <div class="text-block-9">Editor(s)
                        </div>
                        <div id="info-editors">-</div>
                        <div class="text-block-12">Publisher
                        </div>
                        <div id="info-publisher">-</div>
                        <div class="text-block-13">
                            Publication Year</div>
                        <div id="info-year">-</div>
                        <div class="text-block-14">Edition
                        </div>
                        <div id="info-edition">-</div>
                        <div class="text-block-3">ISBN/ISSN
                        </div>
                        <div id="info-isbn">-</div>
                        <div class="text-block-8">Language
                        </div>
                        <div id="info-language">-</div>
                        <div class="text-block-15">Number of
                            Pages</div>
                        <div id="info-pages">-</div>
                        <div class="text-block-6">
                            Subject/Keywords</div>
                        <div id="info-keywords">-</div>
                        <div class="text-block-6">Category
                        </div>
                        <div id="info-category">-</div>
                        <div class="text-block-6">Document
                            Type</div>
                        <div id="info-type">-</div>
                        <div class="text-block-6">Scanning
                            Date</div>
                        <div id="info-scan-date">-</div>
                        <div class="text-block-6">
                            Archivist&#x27;s Name</div>
                        <div id="info-archivist">-</div>
                        <div class="text-block-6">Access
                            Restrictions</div>
                        <div id="info-access">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="footer"></div>

    <!-- Load jQuery and scripts for components -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <!-- Add CSS for document request form -->
    <link rel="stylesheet" href="../css/document-request.css">
    
    <!-- Load document access script -->
    <script src="../js/document-access.js"></script>
    
    <!-- Load Webflow script -->
    <script src="../js/webflow-script.js"></script>

    <script>
        // Wait for the document to be ready
        $(document).ready(function() {
            // Use jQuery's load method which is specifically designed for loading HTML fragments
            $("#header").load("../Components/header.html", function() {
                // This callback runs after the header is loaded
                console.log("Header loaded successfully");
                
                // Load the header-init.js script to handle user login state
                $.getScript("../Components/js/header-init.js")
                    .done(function() {
                        console.log("Header init script loaded successfully");
                    })
                    .fail(function(jqxhr, settings, exception) {
                        console.error("Error loading header-init.js:", exception);
                    });
            });
            
            // Load the footer
            $("#footer").load("../Components/footer.html", function() {
                console.log("Footer loaded successfully");
            });
        });
    </script>

    <!-- Document data fetching script -->
    <script>
        // Configuration
        const API_BASE_URL = '/api'; // Base API URL
        const PLACEHOLDER_COVER_URL = '../images/peas-1-.png'; // Default cover image
        
        // DOM elements
        const elements = {
            title: document.getElementById('document-title'),
            author: document.getElementById('document-author'),
            year: document.getElementById('document-year'),
            cover: document.getElementById('document-cover'),
            abstract: document.getElementById('document-abstract'),
            readLink: document.getElementById('read-document-link'),
            // Info grid elements
            infoTitle: document.getElementById('info-title'),
            infoAuthors: document.getElementById('info-authors'),
            infoEditors: document.getElementById('info-editors'),
            infoPublisher: document.getElementById('info-publisher'),
            infoYear: document.getElementById('info-year'),
            infoEdition: document.getElementById('info-edition'),
            infoISBN: document.getElementById('info-isbn'),
            infoLanguage: document.getElementById('info-language'),
            infoPages: document.getElementById('info-pages'),
            infoKeywords: document.getElementById('info-keywords'),
            infoCategory: document.getElementById('info-category'),
            infoType: document.getElementById('info-type'),
            infoScanDate: document.getElementById('info-scan-date'),
            infoArchivist: document.getElementById('info-archivist'),
            infoAccess: document.getElementById('info-access'),
        };

        // Helper functions
        function setText(element, text) {
            if (element) {
                element.textContent = text || '-';
            }
        }

        function setLink(element, url) {
            if (element) {
                element.href = url || '#';
            }
        }

        // Get document ID from URL
        function getDocumentId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Fetch document data from API
        async function fetchDocumentData(documentId) {
            if (!documentId) {
                showError("No document ID provided");
                return null;
            }

            try {
                // Get the document details
                const apiUrl = `${API_BASE_URL}/documents/${documentId}`;
                console.log(`Fetching document from: ${apiUrl}`);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError("Document not found");
                    } else {
                        console.error(`API Error: ${response.status} ${response.statusText}`);
                        throw new Error("Failed to fetch document");
                    }
                    return null;
                }

                const data = await response.json();
                
                // Check if we have document data
                if (!data) {
                    console.error("No data received from API");
                    throw new Error("No data received from API");
                }

                // The document data is directly in the response
                const documentData = data;
                console.log("Document data retrieved successfully", documentData);

                // Try to get authors for this document
                try {
                    const authorsUrl = `${API_BASE_URL}/document-authors/${documentId}`;
                    console.log(`Fetching document authors from: ${authorsUrl}`);
                    
                    const authorsResponse = await fetch(authorsUrl);
                    
                    if (authorsResponse.ok) {
                        const authorsData = await authorsResponse.json();
                        // Add authors to the document data
                        documentData.authors = authorsData.authors || [];
                        documentData.author_names = authorsData.authors?.map(author => author.full_name) || [];
                        console.log("Authors retrieved successfully", documentData.authors);
                    } else {
                        console.warn("Could not fetch document authors, using empty array");
                        documentData.authors = [];
                        documentData.author_names = [];
                    }
                } catch (authorsError) {
                    console.error("Error fetching document authors:", authorsError);
                    documentData.authors = [];
                    documentData.author_names = [];
                }

                return documentData;
            } catch (error) {
                console.error("Failed to fetch document data:", error);
                showError(`${error.message}. Please try again later.`);
                return null;
            }
        }

        // Render document data to the page
        function renderDocumentData(data) {
            if (!data) return;

            // Set document title in page title
            document.title = data.title || "Document";

            // Main display area
            setText(elements.title, data.title);
            setText(elements.author, data.author_names?.join(', ') || data.authors?.map(a => a.full_name).join(', '));
            setText(elements.year, data.publication_year || (data.publication_date ? new Date(data.publication_date).getFullYear() : "-"));
            setText(elements.abstract, data.abstract || "No abstract available.");

            // Set cover image
            if (data.cover_image) {
                elements.cover.src = data.cover_image;
                elements.cover.srcset = ''; // Clear the srcset if using a specific image
            }

            // Set PDF link
            if (data.pdf_url || data.file_path) {
                setLink(elements.readLink, data.pdf_url || data.file_path);
            }

            // If this is a compiled document, add a "Compiled Document" badge
            if (data.is_compiled) {
                // Add a badge to the title
                elements.title.innerHTML = `${data.title} <span class="compiled-badge">Compiled Document</span>`;
                
                // Display child documents if available
                if (data.children && data.children.length > 0) {
                    // Create a section for child documents
                    const childSection = document.createElement('div');
                    childSection.className = 'child-documents-section';
                    childSection.innerHTML = `
                        <h2 class="heading-3">Included Documents</h2>
                        <div class="child-documents-list"></div>
                    `;
                    
                    const listContainer = childSection.querySelector('.child-documents-list');
                    
                    data.children.forEach(child => {
                        const childItem = document.createElement('a');
                        childItem.href = `open-doc.html?id=${child.id}`;
                        childItem.className = 'child-document-item';
                        
                        childItem.innerHTML = `
                            <div class="child-document-title">${child.title}</div>
                            ${child.author_names ? `<div class="child-document-author">${child.author_names.join(', ')}</div>` : ''}
                        `;
                        
                        listContainer.appendChild(childItem);
                    });
                    
                    // Insert after the abstract
                    const abstractSection = elements.abstract.closest('.text-box');
                    abstractSection.parentNode.insertBefore(childSection, abstractSection.nextSibling);
                }
            }

            // Information grid
            setText(elements.infoTitle, data.title);
            setText(elements.infoAuthors, data.author_names?.join(', ') || data.authors?.map(a => a.full_name).join(', '));
            setText(elements.infoEditors, data.editors?.join(', '));
            setText(elements.infoPublisher, data.publisher);
            setText(elements.infoYear, data.publication_year || (data.publication_date ? new Date(data.publication_date).getFullYear() : "-"));
            setText(elements.infoEdition, data.edition);
            setText(elements.infoISBN, data.isbn_issn);
            setText(elements.infoLanguage, data.language);
            setText(elements.infoPages, data.page_count);
            setText(elements.infoKeywords, data.keywords?.join(', ') || data.tags?.join(', '));
            setText(elements.infoCategory, data.category || data.category_name);
            setText(elements.infoType, data.document_type);
            setText(elements.infoScanDate, data.scanning_date);
            setText(elements.infoArchivist, data.archivist_name);
            setText(elements.infoAccess, data.access_restrictions || "Open Access");

            // Set up read document button click handler
            if (elements.readLink) {
                elements.readLink.onclick = async function(e) {
                    e.preventDefault();
                    
                    // Check if documentAccess is available
                    if (!window.documentAccess) {
                        console.error("Document access module not loaded");
                        showError("Document access module not loaded. Please refresh the page.");
                        return;
                    }
                    
                    // Check document access
                    const hasAccess = await window.documentAccess.checkDocumentAccess(data.id);
                    
                    if (hasAccess && data.file_path) {
                        // Ensure we have a fully qualified URL
                        let pdfPath = data.file_path;
                        if (!pdfPath.startsWith('http') && !pdfPath.startsWith('/')) {
                            pdfPath = '/' + pdfPath;
                        }
                        if (pdfPath.startsWith('/')) {
                            pdfPath = window.location.origin + pdfPath;
                        }
                        
                        // Open document in new tab
                        window.open(pdfPath, '_blank');
                    }
                    // If no access, the request form will be shown automatically by checkDocumentAccess
                };
            }
        }

        // Show error message
        function showError(message) {
            console.error(message);
            setText(elements.title, "Error Loading Document");
            setText(elements.abstract, `Error: ${message}. Please try again later or contact support.`);
        }

        // Initialize
        async function initialize() {
            try {
                const documentId = getDocumentId();
                
                if (!documentId) {
                    showError("No document ID provided in the URL");
                    return;
                }
                
                // Display loading state
                setText(elements.title, "Loading document...");
                setText(elements.abstract, "Loading content...");
                
                // Fetch document data from API
                console.log(`Fetching document with ID: ${documentId}`);
                const documentData = await fetchDocumentData(documentId);
                
                if (documentData) {
                    // Render the document data
                    renderDocumentData(documentData);
                } else {
                    showError("Document not found or could not be loaded");
                }
            } catch (error) {
                console.error("Error in initialization:", error);
                showError("An unexpected error occurred");
            }
        }

        // Add CSS for compiled document components
        const style = document.createElement('style');
        style.textContent = `
            .compiled-badge {
                display: inline-block;
                background-color: #31923d;
                color: white;
                font-size: 14px;
                padding: 3px 8px;
                border-radius: 4px;
                margin-left: 10px;
                vertical-align: middle;
                font-weight: normal;
            }
            
            .child-documents-section {
                margin-top: 30px;
                margin-bottom: 30px;
                padding: 20px;
                background-color: #f9f9f9;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            .child-documents-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }
            
            .child-document-item {
                padding: 15px;
                background-color: white;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s, box-shadow 0.2s;
                text-decoration: none;
                color: inherit;
                display: block;
            }
            
            .child-document-item:hover {
                transform: translateY(-3px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }
            
            .child-document-title {
                font-weight: 600;
                font-size: 16px;
                margin-bottom: 5px;
                color: #31923d;
            }
            
            .child-document-author {
                font-size: 14px;
                color: #666;
            }
        `;
        document.head.appendChild(style);

        // Run initialization when document is ready
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>

</html>